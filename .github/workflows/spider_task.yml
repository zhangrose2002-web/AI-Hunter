name: AI Hunter Engine Sync

on:
  # 1. 响应 spider.html 控制台发出的远程指令
  repository_dispatch:
    types: [run-spider]
  
  # 2. 每天凌晨 2 点自动运行 (北京时间)
  schedule:
    - cron: '0 18 * * *' 
  
  # 3. 允许在 GitHub 界面上手动点击运行
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # 必须显式声明写权限，否则无法推送数据回仓库
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Run Spider Engine
        run: python spider.py
        # 此步会生成新的 data.json 并尝试上传 FTP

      - name: Commit and Push Changes
        run: |
          git config --global user.name "AI-Hunter-Bot"
          git config --global user.email "bot@insight.ai"
          
          # 关键步骤：先拉取远程改动，并使用 rebase 模式避免冲突
          git pull --rebase origin main
          
          git add data.json
          git commit -m "Update Leads Data: $(date)" || exit 0
          
          # 强制推送，确保数据一定能更新
          git push origin main
